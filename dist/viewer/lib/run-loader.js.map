{
  "version": 3,
  "sources": ["../../../src/viewer/lib/run-loader.ts"],
  "sourcesContent": ["import fs from \"node:fs/promises\";\nimport path from \"node:path\";\nimport crypto from \"node:crypto\";\nimport { extractPrimarySection } from \"./primary-section.js\";\nimport { sanitizeLabel } from \"../../lib/benchmark.mjs\";\n\nexport interface RunMeta {\n  benchmark: string;\n  runId: string;\n  timestamp: string;\n  description: string;\n  productName?: string; // Legacy field\n  valueProp?: string; // Legacy field\n  notes?: string;\n  temperature?: number;\n  maxOutputTokens?: number;\n  models?: unknown;\n}\n\nexport interface VariantMetadata {\n  provider: string;\n  model: string;\n  label?: string | null;\n  temperature?: number;\n  maxOutputTokens?: number;\n  description?: string;\n  productName?: string; // Legacy field\n  valueProp?: string; // Legacy field\n  notes?: string;\n}\n\nexport interface BenchmarkVariant {\n  variantKey: string;\n  runId: string;\n  runTimestamp: string;\n  runMeta: RunMeta;\n  metadata: VariantMetadata;\n  responseTextPath: string;\n  primaryHtml: string;\n  primaryRaw: string;\n  sourceText: string;\n}\n\nexport interface LoadVariantsOptions {\n  runsDir?: string;\n}\n\nconst DEFAULT_RUNS_DIR = path.resolve(process.cwd(), \"runs\", \"html-design\");\n\nexport async function loadVariants(options: LoadVariantsOptions = {}): Promise<BenchmarkVariant[]> {\n  const runsDir = options.runsDir ?? DEFAULT_RUNS_DIR;\n  const entries = await safeReadDir(runsDir);\n  const runs = entries.filter((entry) => entry.isDirectory());\n\n  const variants: BenchmarkVariant[] = [];\n  for (const runEntry of runs) {\n    const runPath = path.join(runsDir, runEntry.name);\n    const runMeta = await readRunMeta(runPath);\n    if (!runMeta) continue;\n\n    const variantEntries = await safeReadDir(runPath);\n    for (const variantEntry of variantEntries) {\n      if (!variantEntry.isDirectory()) continue;\n      const variantPath = path.join(runPath, variantEntry.name);\n      const variant = await buildVariant(runMeta, runEntry.name, variantPath);\n      if (variant) {\n        variants.push(variant);\n      }\n    }\n  }\n\n  return variants.sort((a, b) => a.runTimestamp.localeCompare(b.runTimestamp));\n}\n\nasync function buildVariant(runMeta: RunMeta, runFolderName: string, variantPath: string): Promise<BenchmarkVariant | null> {\n  const responsePath = path.join(variantPath, \"response.txt\");\n  const metadataPath = path.join(variantPath, \"metadata.json\");\n\n  const [responseText, variantMeta] = await Promise.all([\n    safeReadFile(responsePath),\n    readVariantMeta(metadataPath),\n  ]);\n\n  if (!responseText || !variantMeta) {\n    return null;\n  }\n\n  const extraction = extractPrimarySection(responseText);\n  const variantKey = getVariantKey(runFolderName, variantMeta, variantPath);\n\n  return {\n    variantKey,\n    runId: runMeta.runId ?? runFolderName,\n    runTimestamp: runMeta.timestamp,\n    runMeta,\n    metadata: variantMeta,\n    responseTextPath: responsePath,\n    primaryHtml: extraction.sanitizedHtml,\n    primaryRaw: extraction.rawSection,\n    sourceText: responseText,\n  };\n}\n\nfunction getVariantKey(runFolderName: string, metadata: VariantMetadata, variantPath: string): string {\n  const rawLabel = metadata.label ?? metadata.model ?? path.basename(variantPath);\n  const label = sanitizeLabel(rawLabel);\n  const composite = `${runFolderName}:${metadata.provider}:${metadata.model}:${label}`;\n  const hash = crypto.createHash(\"sha1\").update(composite).digest(\"hex\").slice(0, 12);\n  return `${runFolderName}/${label}-${hash}`;\n}\n\nasync function readRunMeta(runPath: string): Promise<RunMeta | null> {\n  const metaPath = path.join(runPath, \"meta.json\");\n  try {\n    const data = await fs.readFile(metaPath, \"utf8\");\n    return JSON.parse(data) as RunMeta;\n  } catch {\n    return null;\n  }\n}\n\nasync function readVariantMeta(filePath: string): Promise<VariantMetadata | null> {\n  try {\n    const data = await fs.readFile(filePath, \"utf8\");\n    return JSON.parse(data) as VariantMetadata;\n  } catch {\n    return null;\n  }\n}\n\nasync function safeReadFile(filePath: string): Promise<string | null> {\n  try {\n    return await fs.readFile(filePath, \"utf8\");\n  } catch {\n    return null;\n  }\n}\n\nasync function safeReadDir(dirPath: string): Promise<fs.Dirent[]> {\n  try {\n    return await fs.readdir(dirPath, { withFileTypes: true });\n  } catch {\n    return [];\n  }\n}\n\n"],
  "mappings": "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",
  "names": []
}
